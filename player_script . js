// ====== JSONBIN CONFIG ======
const BIN_ID = "692eeefbae596e708f7e9e72";
const API_KEY = "$2a$10$hCALb9EdUjLfi38M4RhCMOdm8.1y36yYtLvW0BYdZTfqjpHtlAY7S";

// ====== جلب المستخدمين ======
async function getUsers() {
  try {
    let res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      headers: { "X-Master-Key": API_KEY }
    });
    let data = await res.json();
    return data.record || {};
  } catch (err) {
    console.error("ERROR getUsers:", err);
    return {};
  }
}

// ====== حفظ المستخدمين ======
async function saveUsers(users) {
  try {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": API_KEY
      },
      body: JSON.stringify({ record: users })
    });
  } catch (err) {
    console.error("ERROR saveUsers:", err);
  }
}

// ====== LOGIN ======
async function login() {
  let u = document.getElementById("username").value.trim();
  let p = document.getElementById("password")?.value?.trim() || "";

  if (!u) {
    alert("Enter username");
    return;
  }

  let users = await getUsers();

  if (!users[u]) {
    alert("User not found");
    return;
  }

  // Admin بدون كلمة مرور
  if (u === "admin") {
    localStorage.setItem("player_logged", u);
    window.location.href = "player_home.html";
    return;
  }

  // اللاعبين بكلمة مرور
  if (users[u].password !== p) {
    alert("Wrong password");
    return;
  }

  localStorage.setItem("player_logged", u);
  window.location.href = "player_home.html";
}

// ====== إنشاء حساب جديد ======
async function createAccount(username, password) {
  let users = await getUsers();

  if (users[username]) {
    alert("Username already exists");
    return false;
  }

  users[username] = {
    password: password,
    balance: 0,
    history: []
  };

  await saveUsers(users);
  return true;
}

// ====== جلب بيانات لاعب ======
async function getPlayer(username) {
  let users = await getUsers();
  return users[username] || null;
}

// ====== تحديث رصيد لاعب ======
async function updateBalance(username, amount) {
  let users = await getUsers();

  if (!users[username]) return false;

  users[username].balance = amount;
  await saveUsers(users);

  return true;
}

// Helpers for debugging
window.getUsers = getUsers;
window.saveUsers = saveUsers;
window.createAccount = createAccount;
window.getPlayer = getPlayer;
window.updateBalance = updateBalance;
